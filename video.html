<!-- 
References:
	http://html5doctor.com/video-canvas-magic/
	http://www.nihilogic.dk/labs/canvas2image/
	http://www.williammalone.com/articles/create-html5-canvas-javascript-drawing-app/
	http://dev.opera.com/articles/view/custom-html5-video-player-with-css3-and-jquery/
-->
<!DOCTYPE html>
<html>
<head>
	<style>
		body {
			background: #111;
			color:#eee;
		}
		#c {
			width: 640px;
			height: 360px;
			float: left;
		}
		#v {
			display:none;
			width:640px;
			height:360px;
		}
		#main{
			width:650px;
			margin:auto;
		}
		.toolList{
			float:left;
			width:100%;
		}
	</style>
	<link href="css/ghindaVideoPlayer.css" rel="stylesheet" type="text/css">
</head>
<body>
	<div id="main">
		<canvas id="c"></canvas><!-- the canvas -->
		<video width="640" height="360" autobuffer="true" controls="true" poster="http://www.travisberry.com/html5video/videos/demo/demoani1-poster.jpg" id="v" tabindex="0">
			<source src="videos/sintel-trailer.ogv" type='video/ogg; codecs="theora, vorbis"'>
			<source src="videos/sintel-trailer.mp4" type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'>
		</video>
		<!-- The video controls-->
		<div class="ghinda-video-controls">
			<a class="ghinda-video-play" title="Play/Pause"></a>
			<div class="ghinda-video-seek"></div>
			<div class="ghinda-video-timer">00:00</div>
			<div class="ghinda-volume-box">
				<div class="ghinda-volume-slider"></div>
				<a class="ghinda-volume-button" title="Mute/Unmute"></a>
			</div>
		</div>
		<!-- Draw controls -->
		<ul class="toolList">
			<li>Clear the canvas: <button type="button" id="clearCanvas">Clear</button></li>
			<li><span class="highlight">Choose a color: </span><button type="button" id="choosePurpleColors">Purple</button><button type="button" id="chooseGreenColors">Green</button><button type="button" id="chooseYellowColors">Yellow</button><button type="button" id="chooseBrownColors">Brown</button></li>
			<li><span class="highlight">Choose a size: </span><button type="button" id="chooseSmallSizes">Small</button><button type="button" id="chooseNormalSizes">Normal</button><button type="button" id="chooseLargeSizes">Large</button><button type="button" id="chooseHugeSizes">Huge</button></li>
			<li><button type="button" id="chooseWhiteColors">Eraser</button></li>
		</ul>
		<!-- Save image-->
		<div style="display: block; float:left;" id="buttoncontainer">
			<input type="button" value="Save PNG" id="savepngbtn">
			<input type="button" value="Convert to PNG" id="convertpngbtn">
			<br>
			<input type="button" value="Save BMP" id="savebmpbtn">
			<input type="button" value="Convert to BMP" id="convertbmpbtn">
			<br>
			<input type="button" value="Save JPEG" id="savejpegbtn">
			<input type="button" value="Convert to JPEG" id="convertjpegbtn">
		</div>
		<div style="display: none; font-style: italic;" id="textdownload">Now you can right click and download the image<br>
			<input type="button" value="Reset" id="resetbtn">
		</div>
	</div><!-- End #main -->
	
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.12/jquery-ui.min.js"></script><!-- Needed by player controls-->
	<script type="text/javascript" src="js/canvas2image.js"></script><!-- Needed to save image to desktop-->
	<script type="text/javascript" src="js/base64.js"></script><!-- Needed to save image to desktop-->
	<!--[if IE]><script type="text/javascript" src="excanvas.js"></script><![endif]-->
	<script>
		//draw the video to a canvas element
		document.addEventListener('DOMContentLoaded', function(){
			var v = document.getElementById('v');
			var canvas = document.getElementById('c');
			var context = canvas.getContext('2d');
			var cw = canvas.clientWidth;
			var ch = canvas.clientHeight;
			canvas.width = cw;
			canvas.height = ch;
			v.addEventListener('play', function(){
				draw(this,context,cw,ch);
			},false);
		},false);

		function draw(v,c,w,h) {
			if(v.paused || v.ended) return false;
			c.drawImage(v,0,0,w,h);
			setTimeout(draw,20,v,c,w,h);
		}
	</script>
	<script>
		//Draw in canvas script
		//Declare four color variables: colorPurple, colorGreen, colorYellow, colorBrown with corresponding hex color values, 
		//a variable to store the current color: curColor, and an array to match the chosen color when the user clicked the canvas clickColor.
		//Create a cursor size as well.
		var colorPurple = "#cb3594";
		var colorGreen = "#659b41";
		var colorYellow = "#ffcf33";
		var colorBrown = "#986928";
		var colorWhite = "#ffffff";

		var curColor = colorPurple;
		var clickColor = new Array();

		var clickSize = new Array();
		var curSize = "normal";
		var canvasWidth = 640;
		var canvasHeight = 360;
		canvas = document.getElementById('c');
		context = document.getElementById('c').getContext("2d");



		//Mouse Down Event: When the user clicks on canvas we record the position in an array via the addClick function. 
		//We set the boolean paint to true. Finally we update the canvas with the function redraw.
		$('#c').mousedown(function(e){
			var mouseX = e.pageX - this.offsetLeft;
			var mouseY = e.pageY - this.offsetTop;

			paint = true;
			addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop);
			redraw();
		});

		//clear canvas on "Clear" button press
		$('#clearCanvas').mousedown(function(e){
			clickX = new Array();
			clickY = new Array();
			clickDrag = new Array();
			clickColor = new Array();
			clearCanvas();
		});

		//button mousedown events to select color and cursor size
		$('#choosePurpleColors').mousedown(function(e){
			curColor = colorPurple;
		});
		$('#chooseGreenColors').mousedown(function(e){
			curColor = colorGreen;
		});
		$('#chooseYellowColors').mousedown(function(e){
			curColor = colorYellow;
		});
		$('#chooseBrownColors').mousedown(function(e){
			curColor = colorBrown;
		});
		$('#chooseWhiteColors').mousedown(function(e){
			curColor = colorWhite;
		});
		$('#chooseSmallSizes').mousedown(function(e){
			curSize = "small";
		});
		$('#chooseNormalSizes').mousedown(function(e){
			curSize = "normal";
		});
		$('#chooseLargeSizes').mousedown(function(e){
			curSize = "large";
		});
		$('#chooseHugeSizes').mousedown(function(e){
			curSize = "huge";
		});

		//Mouse Move Event: Just like moving the tip of a marker on a sheet of paper, we want to draw on the canvas when our user is pressing down. 
		//The boolean paint will let us know if the virtual marker is pressing down on the paper or not. 
		//If paint is true, then we record the value. Then redraw.
		$('#c').mousemove(function(e){
			if(paint){
				addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop, true);
				redraw();
			}
		});

		//Mouse Up Event: Marker is off the paper; paint boolean will remember!
		$('#c').mouseup(function(e){
			paint = false;
		});

		//Mouse Leave Event: If the marker goes off the paper, then forget you!
		$('#c').mouseleave(function(e){
			paint = false;
		});

		//Here is the addClick function that will save the click position:
		var clickX = new Array();
		var clickY = new Array();
		var clickDrag = new Array();
		var paint;

		function addClick(x, y, dragging){
			clickX.push(x);
			clickY.push(y);
			clickDrag.push(dragging);
			clickColor.push(curColor);
			clickSize.push(curSize);
		}

		//The redraw function is where the magic happens. Each time the function is called the canvas is cleared and everything is redrawn. 
		//We could be more efficient and redraw only certain aspects that have been changed, but let's keep it simple.
		//We set a few stroke properties for the color, shape, and width. Then for every time we recorded as a marker on paper we are going to draw a line.
		function redraw(){
			//canvas.width = canvas.width; // Clears the canvas
			context.lineJoin = "round";
			var radius = 5;
			for(var i=0; i < clickX.length; i++){
				if(clickSize[i] == "small"){
					radius = 2;
				}else if(clickSize[i] == "normal"){
					radius = 5;
				}else if(clickSize[i] == "large"){
					radius = 10;
				}else if(clickSize[i] == "huge"){
					radius = 20;
				}
				context.beginPath();
				if(clickDrag[i] && i){
					context.moveTo(clickX[i-1], clickY[i-1]);
				}else{
					context.moveTo(clickX[i]-1, clickY[i]);
				}
				context.lineTo(clickX[i], clickY[i]);
				context.closePath();
				context.strokeStyle = clickColor[i];
				context.lineWidth = radius;
				context.stroke();
			}
		}
		
		//clear canvas
		function clearCanvas(){
			context.fillStyle = '#ffffff'; // Work around for Chrome
			context.fillRect(0, 0, canvasWidth, canvasHeight); // Fill in the canvas with white
			canvas.width = canvas.width; // clears the canvas
			//now quickly restart and stop video so frame doesnt go black
			// $('#v').gVideo().play();
			// $('#v').gVideo().pause();
		}
	</script>
	<script src="js/jquery.ghindaVideoPlayer.min.js"></script><!-- Player controls script-->
	<script>
		//instantiate player controls
		$(function() {
			$('#v').gVideo();		
		});
	</script>
	<script>
		//save image to desktop
		var oCanvas = document.getElementById("c");  

		function showDownloadText() {
		document.getElementById("buttoncontainer").style.display = "none";
		document.getElementById("textdownload").style.display = "block";
		}
		function hideDownloadText() {
		document.getElementById("buttoncontainer").style.display = "block";
		document.getElementById("textdownload").style.display = "none";
		}

		function convertCanvas(strType) {
			if (strType == "PNG"){
				var oImg = Canvas2Image.saveAsPNG(oCanvas, true);
			}
			if (strType == "BMP"){
				var oImg = Canvas2Image.saveAsBMP(oCanvas, true);
			}
			if (strType == "JPEG"){
				var oImg = Canvas2Image.saveAsJPEG(oCanvas, true);
			}
			if (!oImg) {
				alert("Sorry, this browser is not capable of saving " + strType + " files!");
				return false;
			}
			oImg.id = "canvasimage";
			oImg.style.border = oCanvas.style.border;
			oCanvas.parentNode.replaceChild(oImg, oCanvas);
			showDownloadText();
		}
		function saveCanvas(pCanvas, strType) {
			var bRes = false;
			if (strType == "PNG"){
				bRes = Canvas2Image.saveAsPNG(oCanvas);
			}
			if (strType == "BMP"){
				bRes = Canvas2Image.saveAsBMP(oCanvas);
			}
			if (strType == "JPEG"){
				bRes = Canvas2Image.saveAsJPEG(oCanvas);
			}
			if (!bRes) {
				alert("Sorry, this browser is not capable of saving " + strType + " files!");
				return false;
			}
		}
		document.getElementById("savepngbtn").onclick = function() {
			saveCanvas(oCanvas, "PNG");
		}
		document.getElementById("savebmpbtn").onclick = function() {
			saveCanvas(oCanvas, "BMP");
		}
		document.getElementById("savejpegbtn").onclick = function() {
			saveCanvas(oCanvas, "JPEG");
		}
		document.getElementById("convertpngbtn").onclick = function() {
			convertCanvas("PNG");
		}
		document.getElementById("convertbmpbtn").onclick = function() {
			convertCanvas("BMP");
		}
		document.getElementById("convertjpegbtn").onclick = function() {
			convertCanvas("JPEG");
		}
		document.getElementById("resetbtn").onclick = function() {
			var oImg = document.getElementById("canvasimage");
			oImg.parentNode.replaceChild(oCanvas, oImg);
			hideDownloadText();
		}
	</script>
</body>
</html>